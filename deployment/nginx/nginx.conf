# nginx.conf
# Reverse proxy for DataGenius PRO
# - /api/**  -> FastAPI backend (datagenius-api:8000)
# - /*       -> Streamlit UI (datagenius-ui:8501), incl. WebSockets

worker_processes auto;

events {
  worker_connections 1024;
}

http {
  include       mime.types;
  default_type  application/octet-stream;

  sendfile        on;
  tcp_nopush      on;
  tcp_nodelay     on;
  keepalive_timeout  65;

  # Allow large uploads (CSV, Parquet, Excel)
  client_max_body_size 100M;

  # Gzip for text assets
  gzip on;
  gzip_comp_level 5;
  gzip_min_length 1024;
  gzip_proxied any;
  gzip_types
      text/plain text/css application/json application/javascript
      application/x-javascript text/xml application/xml
      application/xml+rss text/javascript image/svg+xml;

  # WebSocket upgrade helper
  map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
  }

  # Upstreams (match service names in Docker/K8s)
  upstream api_upstream {
    server datagenius-api:8000;
    keepalive 32;
  }

  upstream ui_upstream {
    server datagenius-ui:8501;
    keepalive 32;
  }

  server {
    listen 80;
    server_name _;

    # --- Security headers (tweak as needed) ---
    add_header X-Content-Type-Options nosniff always;
    add_header X-Frame-Options SAMEORIGIN always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    # CSP kept permissive due to Streamlit/Plotly; harden if you pin origins
    add_header Content-Security-Policy "default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: http: https: ws: wss:; connect-src *; img-src * data: blob:; font-src * data:; media-src * data: blob:;" always;

    # --- Healthcheck (proxies to API /health) ---
    location = /health {
      proxy_pass http://api_upstream/health;
      proxy_set_header Host              $host;
      proxy_set_header X-Real-IP         $remote_addr;
      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    # --- API routing ---
    location /api/ {
      proxy_http_version 1.1;
      proxy_pass http://api_upstream;
      proxy_set_header Host              $host;
      proxy_set_header X-Real-IP         $remote_addr;
      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_connect_timeout 60s;
      proxy_send_timeout    600s;
      proxy_read_timeout    600s;

      # CORS (adjust Allowed-Origin in prod if you have a known domain)
      if ($request_method = OPTIONS) {
        add_header 'Access-Control-Allow-Origin'  '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET,POST,PUT,PATCH,DELETE,OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type,X-Requested-With' always;
        add_header 'Access-Control-Max-Age'       86400 always;
        return 204;
      }
      add_header 'Access-Control-Allow-Origin'      '*' always;
      add_header 'Access-Control-Allow-Credentials' 'true' always;
    }

    # --- Streamlit WebSocket endpoints ---
    location /stream {
      proxy_http_version 1.1;
      proxy_set_header Upgrade           $http_upgrade;
      proxy_set_header Connection        $connection_upgrade;
      proxy_set_header Host              $host;
      proxy_pass http://ui_upstream;
      proxy_read_timeout 3600s;
    }

    location /_stcore/ {
      proxy_http_version 1.1;
      proxy_set_header Upgrade           $http_upgrade;
      proxy_set_header Connection        $connection_upgrade;
      proxy_set_header Host              $host;
      proxy_pass http://ui_upstream;
      proxy_read_timeout 3600s;
    }

    # --- UI root & general pages ---
    location / {
      proxy_pass http://ui_upstream;
      proxy_set_header Host              $host;
      proxy_set_header X-Real-IP         $remote_addr;
      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_read_timeout 3600s;
    }

    # --- Static asset caching (served by UI) ---
    location ~* \.(?:css|js|mjs|png|jpe?g|gif|ico|svg|woff2?|ttf|eot)$ {
      expires 30d;
      add_header Cache-Control "public, max-age=2592000, immutable";
      proxy_pass http://ui_upstream;
    }
  }
}
